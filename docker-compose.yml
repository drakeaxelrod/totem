services:
  zmk:
    image: zmkfirmware/zmk-build-arm:stable
    volumes:
      - ./zmk-firmware/config:/zmk-config:ro
      - zmk-west:/workspace
      - ./build:/build
    working_dir: /workspace
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        find /workspace -name '*.lock' -delete 2>/dev/null || true
        rm -rf config && cp -r /zmk-config config
        [ -f .west/config ] || west init -l config
        west update --fetch-opt=--filter=tree:0
        west zephyr-export
        echo "Building left (central)..."
        west build -s zmk/app -d build/left -b xiao_ble -p -- -DZMK_CONFIG=/workspace/config -DSHIELD=totem_left
        echo "Building right (peripheral)..."
        west build -s zmk/app -d build/right -b xiao_ble -p -- -DZMK_CONFIG=/workspace/config -DSHIELD=totem_right
        echo "Building settings reset..."
        west build -s zmk/app -d build/reset -b xiao_ble -p -- -DSHIELD=settings_reset
        cp build/left/zephyr/zmk.uf2 /build/zmk-left.uf2
        cp build/right/zephyr/zmk.uf2 /build/zmk-right.uf2
        cp build/reset/zephyr/zmk.uf2 /build/zmk-settings-reset.uf2
        chown 1000:100 /build/zmk-*.uf2
        echo "ZMK build complete"

  rmk:
    build:
      context: docker
      dockerfile: Dockerfile.rmk
    volumes:
      - ./rmk-firmware:/src:ro
      - rmk-cargo-registry:/usr/local/cargo/registry
      - rmk-cargo-git:/usr/local/cargo/git
      - rmk-target:/work/target
      - ./build:/build
    working_dir: /work
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        cp -r /src/* .
        cp -r /src/.cargo . 2>/dev/null || true
        echo "Building RMK firmware (normal + reset)..."
        cargo make uf2
        cp build/totem-left.uf2 /build/rmk-left.uf2
        cp build/totem-right.uf2 /build/rmk-right.uf2
        cp build/totem-left-reset.uf2 /build/rmk-left-reset.uf2
        cp build/totem-right-reset.uf2 /build/rmk-right-reset.uf2
        chown 1000:100 /build/rmk-*.uf2
        echo "RMK build complete"

  app:
    build:
      context: docker
      dockerfile: Dockerfile.app
    volumes:
      - .:/project:ro
      - app-node-modules:/work/node_modules
      - app-cargo-registry:/usr/local/cargo/registry
      - app-target:/work/src-tauri/target
      - ./build:/build
    working_dir: /work
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        export CI=true
        cp -r /project/app/* .
        mkdir -p /rmk-firmware /assets
        cp -r /project/rmk-firmware/* /rmk-firmware/
        cp -r /project/assets/* /assets/ 2>/dev/null || true
        pnpm install
        WAYLAND_DISPLAY= pnpm tauri build
        cp src-tauri/target/release/bundle/deb/*.deb /build/ 2>/dev/null || true
        cp src-tauri/target/release/bundle/appimage/*.AppImage /build/ 2>/dev/null || true
        chown 1000:100 /build/*.deb /build/*.AppImage 2>/dev/null || true
        echo "App build complete"

volumes:
  zmk-west:
  rmk-cargo-registry:
  rmk-cargo-git:
  rmk-target:
  app-node-modules:
  app-cargo-registry:
  app-target:
