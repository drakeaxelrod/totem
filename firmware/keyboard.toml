# Documentation: https://rmk.rs/docs
# POWER SWITCH: LEFT IS ON, RIGHT IS OFF (BOTH SIDES)
[keyboard]
name = "TOTEM"
product_name = "TOTEM"
vendor_id = 0x4C4B
product_id = 0x544D
manufacturer = "GEIGEIGEIST"
serial_number = "vial:f64c2b3c"
chip = "nrf52840"
usb_enable = true

# TOTEM: 38-key split keyboard
# Matrix: 4 rows x 10 cols (5 cols per side)
# Physical layout:
#          | 00 | 01 | 02 | 03 | 04 |   | 05 | 06 | 07 | 08 | 09 |
#          | 10 | 11 | 12 | 13 | 14 |   | 15 | 16 | 17 | 18 | 19 |
#     | 30 | 20 | 21 | 22 | 23 | 24 |   | 25 | 26 | 27 | 28 | 29 | 39 |
#                    | 32 | 33 | 34 |   | 35 | 36 | 37 |

[layout]
rows = 4
cols = 10
layers = 6
# L/R hand designation enables unilateral_tap (same-hand press = always tap)
matrix_map = """
(0,0,L) (0,1,L) (0,2,L) (0,3,L) (0,4,L) (0,5,R) (0,6,R) (0,7,R) (0,8,R) (0,9,R)
(1,0,L) (1,1,L) (1,2,L) (1,3,L) (1,4,L) (1,5,R) (1,6,R) (1,7,R) (1,8,R) (1,9,R)
(2,0,L) (2,1,L) (2,2,L) (2,3,L) (2,4,L) (2,5,R) (2,6,R) (2,7,R) (2,8,R) (2,9,R)
(3,0,L) (3,1,L) (3,2,L) (3,3,L) (3,4,L) (3,5,R) (3,6,R) (3,7,R) (3,8,R) (3,9,R)
"""
keymap = [
    # Layer 0: Base (Gallium)
    # Top:    B  L  D  C  V  |  J  Y  O  U  ,
    # Home:   N  R  T  S  G  |  P  H  A  E  I   (HRM: Gui Alt Ctrl Shift | Shift Ctrl Alt Gui)
    # Bottom: X  Q  M  W  Z  |  K  F  '  ;  .
    # Thumbs: Tab _ Esc(Util) Space(Nav) StickyShift | Enter Bksp(Num) Del(Fun) _ Tab
    # Hyper (Shift+Ctrl+Alt+Gui) on W and F via chained modifiers in MT()
    [
        ["B",      "L",      "D",      "C",      "V",           "J",      "Y",      "O",      "U",      "Comma"    ],
        ["MT(N,LGui,HRM)", "MT(R,LAlt,HRM)", "MT(T,LCtrl,HRM)", "MT(S,LShift,HRM)", "G",  "P", "MT(H,RShift,HRM)", "MT(A,RCtrl,HRM)", "MT(E,RAlt,HRM)", "MT(I,RGui,HRM)"],
        ["X",      "Q",      "M",      "MT(W, LShift | LCtrl | LAlt | LGui, HRM)", "Z",  "K", "MT(F, RShift | RCtrl | RAlt | RGui, HRM)", "Quote", "Semicolon", "Dot"],
        ["Tab", "_", "LT(4,Escape,TH)", "LT(1,Space,TH)", "Tab", "Enter", "LT(2,Backspace,TH)", "LT(3,Delete,TH)", "_", "Tab"]
    ],
    # Layer 1: Nav (hold Space)
    # Left: editing + explicit mods, Right: vim arrows (HJKL = ←↓↑→) + Home/End/PgUp/PgDn
    [
        ["Undo",   "Cut",    "Copy",   "Paste",  "Again",       "Home",   "PageDown", "PageUp", "End",   "Delete"   ],
        ["LGui",   "LAlt",   "LCtrl",  "LShift", "_",           "_",      "Left",   "Down",   "Up",     "Right"    ],
        ["_",      "_",      "_",      "_",      "_",           "Insert", "CapsWordToggle", "Menu", "_", "_"        ],
        ["WwwBack", "_",     "_",      "_",      "_",           "_",      "_",      "_",      "_",      "WwwForward"]
    ],
    # Layer 2: Num (hold Backspace)
    # Left: numpad + operators, Right: explicit mods for chording
    # Use right-side Shift to chord: Shift+= → +, Shift+8 → *, Shift+9 → (, etc.
    [
        ["KpPlus", "Kc7",    "Kc8",    "Kc9",    "Kc0",  "_",      "_",      "_",      "_",      "_"        ],
        ["KpAsterisk",    "Kc4",    "Kc5",    "Kc6",    "Equal",       "_",      "LShift", "LCtrl",   "LAlt",   "LGui"    ],
        ["Minus",  "Kc1",    "Kc2",    "Kc3",    "Slash",       "_",      "_",      "_",      "_",      "_"        ],
        ["WM(Kc9, LShift)", "_", "_", "Dot", "Semicolon", "_", "_", "_", "_", "WM(Kc0, LShift)"]
    ],
    # Layer 3: Function (hold Delete)
    # Left: F-keys in numpad layout, Right: volume/media/brightness + mods for chording
    # TG(5) on right side button toggles Gaming layer
    [
        ["F12",    "F7",     "F8",     "F9",     "_",           "PrintScreen", "AudioVolDown", "AudioVolUp", "AudioMute", "ScrollLock"],
        ["F11",    "F4",     "F5",     "F6",     "_",           "_",      "LShift", "LCtrl",   "LAlt",   "LGui"    ],
        ["F10",    "F1",     "F2",     "F3",     "_",           "Pause",  "BrightnessDown", "BrightnessUp", "_", "_"],
        ["_",      "_",      "_",      "_",      "_",           "MediaPlayPause", "MediaPrevTrack", "MediaNextTrack", "_", "TG(5)"]
    ],
    # Layer 4: Util + Mouse (hold Escape)
    # Left: BLE + accel, Right: vim-like mouse movement + scroll
    # Thumbs: mouse buttons, volume on top-right
    [
        ["User0",  "User1",  "User2",  "User5",  "_",           "MouseWheelUp", "MouseWheelDown", "AudioVolUp", "MouseWheelLeft", "MouseWheelRight"],
        ["LGui",   "LAlt",   "LCtrl",  "LShift", "_",           "_",      "MouseLeft", "MouseDown", "MouseUp", "MouseRight"],
        ["User6",  "MouseAccel0", "MouseAccel1", "MouseAccel2", "_", "_", "MouseBtn4", "MouseBtn5", "_",   "_"        ],
        ["_",      "_",      "_",      "_",      "_",           "MouseBtn1", "MouseBtn2", "MouseBtn3", "AudioVolDown", "AudioMute"]
    ],
    # Layer 5: Gaming (toggle via TG(5) from Function layer)
    # WASD movement, dedicated mods on bottom (no HRM for gaming)
    [
        ["Q",      "W",      "E",      "R",      "T",           "Kc1",    "Kc2",    "Kc3",    "Kc4",    "Kc5"      ],
        ["A",      "S",      "D",      "F",      "G",           "Kc6",    "Kc7",    "Kc8",    "Kc9",    "Kc0"      ],
        ["MT(Z,LCtrl)", "MT(X,LGui)", "MT(C,LAlt)", "V", "B",   "N",      "M",      "Comma",  "Dot",    "Slash"    ],
        ["Tab", "_",      "Escape", "Space",  "LShift",          "Enter",  "Backspace", "Delete", "_",   "TG(5)"    ]
    ]
]

[storage]
enabled = true
# Clear all storage data on boot, including keymap, BLE bonds, etc
clear_storage = false
# Clear only layout/keymap data, preserve BLE bonds
clear_layout = true


[behavior]
one_shot = { timeout = "1s" }

# Tap-hold behavior configuration
[behavior.morse]
enable_flow_tap = true
prior_idle_time = "150ms"
hold_timeout = "200ms"
gap_timeout = "230ms"

# Per-key profiles for fine-tuned tap-hold behavior
[behavior.morse.profiles]
# Home Row Mods: conservative to prevent misfires during fast typing
# unilateral_tap: same-hand press always triggers tap (prevents accidental mods)
# permissive_hold: press+release another key while holding triggers hold
HRM = { unilateral_tap = true, permissive_hold = true, hold_timeout = "280ms", gap_timeout = "250ms" }
# Thumb Hold: responsive layer activation for thumb keys
# hold_on_other_press: immediately activates layer when another key is pressed
TH = { hold_on_other_press = true, unilateral_tap = false, hold_timeout = "200ms", gap_timeout = "200ms" }

# Combos from bsag layout — positional reference:
#   ╭─────────────────────┬─────────────────────╮
#   │ LT4 LT3 LT2 LT1 LT0 │ RT0 RT1 RT2 RT3 RT4 │
#   │ LM4 LM3 LM2 LM1 LM0 │ RM0 RM1 RM2 RM3 RM4 │
# LB5 LB4 LB3 LB2 LB1 LB0 │ RB0 RB1 RB2 RB3 RB4 RB5
#   ╰───────╮ LH2 LH1 LH0 │ RH0 RH1 RH2 ╭───────╯t
#           ╰─────────────┴─────────────╯
# Gallium: B L D C V | J Y O U ,
#          N R T S G | P H A E I
#     Tab X Q M W Z  | K F ' ; . Tab
[behavior.combo]
timeout = "80ms"
combos = [
    # Left vertical: top + home row — @ # $ %
    { actions = ["L", "MT(R,LAlt,HRM)"], output = "WM(Kc2, LShift)" },
    { actions = ["D", "MT(T,LCtrl,HRM)"], output = "WM(Kc3, LShift)" },
    { actions = ["C", "MT(S,LShift,HRM)"], output = "WM(Kc4, LShift)" },
    { actions = ["V", "G"], output = "WM(Kc5, LShift)" },
    # Left vertical: home + bottom row — ` \ = ~
    { actions = ["MT(R,LAlt,HRM)", "Q"], output = "Grave" },
    { actions = ["MT(T,LCtrl,HRM)", "M"], output = "Backslash" },
    { actions = ["MT(S,LShift,HRM)", "MT(W, LShift | LCtrl | LAlt | LGui, HRM)"], output = "Equal" },
    { actions = ["G", "Z"], output = "WM(Grave, LShift)" },
    # Left horizontal: Escape (N+R+T), clipboard (Ctrl+X/C/V)
    { actions = ["MT(R,LAlt,HRM)", "MT(T,LCtrl,HRM)", "MT(S,LShift,HRM)"], output = "Escape" },
    { actions = ["Q", "MT(W, LShift | LCtrl | LAlt | LGui, HRM)"], output = "WM(X, LCtrl)" },
    { actions = ["Q", "M"], output = "WM(C, LCtrl)" },
    { actions = ["M", "MT(W, LShift | LCtrl | LAlt | LGui, HRM)"], output = "WM(V, LCtrl)" },
    # Right vertical: top + home row — ^ + * &
    { actions = ["J", "P"], output = "WM(Kc6, LShift)" },
    { actions = ["Y", "MT(H,RShift,HRM)"], output = "WM(Equal, LShift)" },
    { actions = ["O", "MT(A,RCtrl,HRM)"], output = "WM(Kc8, LShift)" },
    { actions = ["U", "MT(E,RAlt,HRM)"], output = "WM(Kc7, LShift)" },
    # Right vertical: home + bottom row — _ - / |
    { actions = ["P", "K"], output = "WM(Minus, LShift)" },
    { actions = ["MT(H,RShift,HRM)", "MT(F, RShift | RCtrl | RAlt | RGui, HRM)"], output = "Minus" },
    { actions = ["MT(A,RCtrl,HRM)", "Quote"], output = "Slash" },
    { actions = ["MT(E,RAlt,HRM)", "Semicolon"], output = "WM(Backslash, LShift)" },
    # Right horizontal: brackets [] () {} < >
    { actions = ["Y", "O"], output = "LeftBracket" },
    { actions = ["O", "U"], output = "RightBracket" },
    { actions = ["MT(H,RShift,HRM)", "MT(A,RCtrl,HRM)"], output = "WM(Kc9, LShift)" },
    { actions = ["MT(A,RCtrl,HRM)", "MT(E,RAlt,HRM)"], output = "WM(Kc0, LShift)" },
    { actions = ["MT(F, RShift | RCtrl | RAlt | RGui, HRM)", "Quote"], output = "WM(LeftBracket, LShift)" },
    { actions = ["Quote", "Semicolon"], output = "WM(RightBracket, LShift)" },
    { actions = ["P", "MT(H,RShift,HRM)"], output = "WM(Comma, LShift)" },
    { actions = ["MT(E,RAlt,HRM)", "MT(I,RGui,HRM)"], output = "WM(Dot, LShift)" },
    # Caps word: both index fingers (S + H)
    { actions = ["MT(S,LShift,HRM)", "MT(H,RShift,HRM)"], output = "CapsWordToggle" },
]

# Forks (mod-morphs) — change output based on active modifiers
# Shift+, → ; (instead of <), Shift+. → : (instead of >)
# < and > are available via combos: P+H and E+I
[behavior.fork]
forks = [
    { trigger = "Comma", negative_output = "Comma", positive_output = "Semicolon", match_any = "LShift|RShift" },
    { trigger = "Dot", negative_output = "Dot", positive_output = "WM(Semicolon, LShift)", match_any = "LShift|RShift" },
]

[rmk]
# 28 combos defined — default combo_max_num is too low
combo_max_num = 32
# Mouse: lower interval = faster movement (16ms ≈ 60fps)
mouse_key_interval = 10
# Scroll: lower interval = faster scrolling
mouse_wheel_interval = 50


# Chip-specific config for nRF52840
# WARNING: Only enable DC/DC regulators if your board has external LC filters
# XIAO nRF52840 has these, so it's safe to enable for better power efficiency
[chip.nrf52840]
dcdc_reg0 = true
dcdc_reg1 = true

[ble]
enabled = true
# Battery level reporting via ADC pin with voltage divider (XIAO nRF52840)
battery_adc_pin = "P0_31"
adc_divider_measured = 510
adc_divider_total = 1510
[split]
connection = "ble"

# Central = Left half
[split.central]
rows = 4
cols = 5
row_offset = 0
col_offset = 0

[split.central.matrix]
row_pins = ["P0_02", "P0_03", "P0_28", "P0_29"]
col_pins = ["P0_04", "P0_05", "P1_15", "P1_14", "P1_13"]

# Peripheral = Right half
[[split.peripheral]]
rows = 4
cols = 5
row_offset = 0
col_offset = 5

[split.peripheral.matrix]
row_pins = ["P0_02", "P0_03", "P0_28", "P0_29"]
col_pins = ["P1_13", "P1_14", "P1_15", "P0_05", "P0_04"]
