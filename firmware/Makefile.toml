[tasks.install-llvm-tools]
install_crate = { rustup_component_name = "llvm-tools" }

[tasks.flip-link]
install_crate = { crate_name = "flip-link", binary = "flip-link", test_arg = ["-h"] }

[tasks.mkdir-build]
command = "mkdir"
args = ["-p", "build"]

[tasks.build]
command = "cargo"
args = ["build", "--release"]
dependencies = ["install-llvm-tools", "flip-link"]

[tasks.objcopy-central]
install_crate = { crate_name = "cargo-binutils", binary = "cargo", test_arg = [
    "objcopy",
    "--help",
] }
command = "cargo"
args = [
    "objcopy",
    "--release",
    "--bin",
    "central",
    "--",
    "-O",
    "ihex",
    "build/totem-left.hex",
]
dependencies = ["build", "mkdir-build"]

[tasks.objcopy-peripheral]
install_crate = { crate_name = "cargo-binutils", binary = "cargo", test_arg = [
    "objcopy",
    "--help",
] }
command = "cargo"
args = [
    "objcopy",
    "--release",
    "--bin",
    "peripheral",
    "--",
    "-O",
    "ihex",
    "build/totem-right.hex",
]
dependencies = ["build", "mkdir-build"]

[tasks.uf2-central]
install_crate = { crate_name = "cargo-hex-to-uf2", binary = "cargo", test_arg = [
    "hex-to-uf2",
    "--help",
] }
command = "cargo"
args = [
    "hex-to-uf2",
    "--input-path",
    "build/totem-left.hex",
    "--output-path",
    "build/totem-left.uf2",
    "--family",
    "nrf52840",
]
dependencies = ["objcopy-central"]

[tasks.uf2-peripheral]
install_crate = { crate_name = "cargo-hex-to-uf2", binary = "cargo", test_arg = [
    "hex-to-uf2",
    "--help",
] }
command = "cargo"
args = [
    "hex-to-uf2",
    "--input-path",
    "build/totem-right.hex",
    "--output-path",
    "build/totem-right.uf2",
    "--family",
    "nrf52840",
]
dependencies = ["objcopy-peripheral"]

# Build just the normal UF2s (used internally by uf2 task)
[tasks.uf2-firmware]
dependencies = ["uf2-central", "uf2-peripheral"]

# Default: builds normal + reset UF2s (reset build is fast â€” incremental)
[tasks.uf2]
script_runner = "@shell"
script = [
    "cargo make uf2-firmware",
    "cp build/totem-left.uf2 build/totem-left-normal.uf2",
    "cp build/totem-right.uf2 build/totem-right-normal.uf2",
    "cp keyboard.toml keyboard.toml.build-bak",
    "sed -i '/^clear_storage/s/=.*/= true/' keyboard.toml",
    "cargo make uf2-firmware",
    "cp build/totem-left.uf2 build/totem-left-reset.uf2",
    "cp build/totem-right.uf2 build/totem-right-reset.uf2",
    "mv keyboard.toml.build-bak keyboard.toml",
    "mv build/totem-left-normal.uf2 build/totem-left.uf2",
    "mv build/totem-right-normal.uf2 build/totem-right.uf2",
]

[tasks.clean]
command = "rm"
args = ["-rf", "build", "target"]
