/*
 * TOTEM — Gallium layout with GACS home row mods + Hyper
 *
 * Layers based on bsag's design: symbols via combos, clean layer structure.
 * Adapted for Linux (Ctrl+X/C/V clipboard, Alt+arrows browser nav).
 *
 * Matrix: 4 rows x 10 cols (5 per side)
 *          | 00 | 01 | 02 | 03 | 04 |   | 05 | 06 | 07 | 08 | 09 |
 *          | 10 | 11 | 12 | 13 | 14 |   | 15 | 16 | 17 | 18 | 19 |
 *     | 20 | 21 | 22 | 23 | 24 | 25 |   | 26 | 27 | 28 | 29 | 30 | 31 |
 *                    | 32 | 33 | 34 |   | 35 | 36 | 37 |
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>

#define BASE 0
#define NAV  1
#define NUM  2
#define FUN  3
#define UTIL 4

#define HYP LS(LC(LA(LGUI)))
#define MEH LS(LC(LALT))

#define QUICK_TAP_MS 175

#include "combos.dtsi"

// caps_word: keep active through numbers, backspace, underscore, minus
&caps_word {
    /delete-property/ ignore-numbers;
    continue-list = <BACKSPACE ENTER DELETE UNDERSCORE MINUS>;
};

// sticky key (one-shot mod): 2s timeout, release after next keypress
&sk {
    release-after-ms = <2000>;
    quick-release;
};

// layer-tap defaults for thumb keys
&lt {
    flavor = "balanced";
    tapping-term-ms = <200>;
    quick-tap-ms = <QUICK_TAP_MS>;
};

/ {
    behaviors {
        // Left home row mod — positional, timeless
        hml: home_row_mod_left {
            compatible = "zmk,behavior-hold-tap";
            #binding-cells = <2>;
            flavor = "balanced";
            tapping-term-ms = <280>;
            quick-tap-ms = <QUICK_TAP_MS>;
            require-prior-idle-ms = <150>;
            bindings = <&kp>, <&kp>;
            hold-trigger-key-positions = <5 6 7 8 9 15 16 17 18 19 26 27 28 29 30 32 33 34 35 36 37>;
            hold-trigger-on-release;
        };

        // Right home row mod — positional, timeless
        hmr: home_row_mod_right {
            compatible = "zmk,behavior-hold-tap";
            #binding-cells = <2>;
            flavor = "balanced";
            tapping-term-ms = <280>;
            quick-tap-ms = <QUICK_TAP_MS>;
            require-prior-idle-ms = <150>;
            bindings = <&kp>, <&kp>;
            hold-trigger-key-positions = <0 1 2 3 4 10 11 12 13 14 21 22 23 24 25 32 33 34 35 36 37>;
            hold-trigger-on-release;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        // Layer 0: Base (Gallium)
        // Top:    B  L  D  C  V  |  J  Y  O  U  ,
        // Home:   N  R  T  S  G  |  P  H  A  E  I   (HRM: Gui Alt Ctrl Shift | Shift Ctrl Alt Gui)
        // Bottom: X  Q  M  W* Z  |  K  F* '  ;  .   (* = Hyper HRM)
        // Thumbs: Tab _ Esc(Util) Space(Nav) StickyShift | Enter Bksp(Num) Del(Fun) _ Tab
        base_layer {
            display-name = "Base";
            bindings = <
                &kp B         &kp L         &kp D          &kp C          &kp V             &kp J       &kp Y          &kp O          &kp U         &kp COMMA
                &hml LGUI N   &hml LALT R   &hml LCTRL T   &hml LSHFT S   &kp G             &kp P       &hmr RSHFT H   &hmr RCTRL A   &hmr RALT E   &hmr RGUI I
    &kp TAB     &kp X         &kp Q         &kp M          &hml HYP W     &kp Z             &kp K       &hmr HYP F     &kp SQT        &kp SEMI      &kp DOT       &kp TAB
                                             &lt UTIL ESC   &lt NAV SPACE  &sk LSHFT         &kp RET     &lt NUM BSPC   &lt FUN DEL
            >;
        };

        // Layer 1: Nav (hold Space)
        // Left: explicit mods for chording with arrows
        // Right: arrows + Home/End/PgUp/PgDn
        nav_layer {
            display-name = "Nav";
            bindings = <
                &trans        &trans        &trans         &trans         &trans            &trans      &kp HOME       &kp UP         &kp END       &kp PG_UP
                &kp LCTRL     &kp LALT      &kp LGUI       &kp LSHFT      &trans            &trans      &kp LEFT       &kp DOWN       &kp RIGHT     &kp PG_DN
  &kp LA(LEFT)  &trans        &trans        &kp MEH        &kp HYP        &trans            &trans      &kp TILDE      &trans         &kp FSLH      &trans        &kp LA(RIGHT)
                                             &trans         &trans         &trans            &kp RET     &kp BSPC       &kp DEL
            >;
        };

        // Layer 2: Num (hold Backspace)
        // Left: numpad + operators, Right: explicit mods for chording
        // Side buttons: ( and )
        num_layer {
            display-name = "Num";
            bindings = <
                &kp PLUS      &kp N7        &kp N8         &kp N9         &kp STAR          &trans      &trans         &trans         &trans        &trans
                &kp N0        &kp N4        &kp N5         &kp N6         &kp EQUAL         &trans      &kp LSHFT      &kp LGUI       &kp LALT      &kp LCTRL
    &kp LPAR    &kp MINUS     &kp N1        &kp N2         &kp N3         &kp FSLH          &trans      &kp HYP        &kp MEH        &trans        &trans        &kp RPAR
                                             &trans         &kp DOT        &kp SEMI          &trans      &trans         &trans
            >;
        };

        // Layer 3: Function (hold Delete)
        // Left: F-keys in numpad layout, Right: explicit mods for chording
        fun_layer {
            display-name = "Func";
            bindings = <
                &kp F12       &kp F7        &kp F8         &kp F9         &trans            &trans      &trans         &trans         &trans        &trans
                &kp F11       &kp F4        &kp F5         &kp F6         &trans            &trans      &kp LSHFT      &kp LGUI       &kp LALT      &kp LCTRL
    &trans      &kp F10       &kp F1        &kp F2         &kp F3         &trans            &trans      &kp HYP        &kp MEH        &trans        &trans        &trans
                                             &trans         &trans         &trans            &trans      &trans         &trans
            >;
        };

        // Layer 4: Util (hold Escape)
        // BLE management + volume
        util_layer {
            display-name = "Util";
            bindings = <
                &bt BT_SEL 0  &bt BT_SEL 1  &bt BT_SEL 2   &bt BT_CLR     &trans            &trans      &trans         &kp C_VOL_UP   &trans        &trans
                &kp LCTRL     &kp LALT      &kp LGUI        &kp LSHFT      &trans            &trans      &trans         &kp C_VOL_DN   &trans        &trans
    &trans      &trans        &trans        &trans          &kp HYP        &trans            &trans      &trans         &trans         &trans        &trans        &trans
                                             &trans          &trans         &trans            &trans      &trans         &kp C_MUTE
            >;
        };
    };
};
